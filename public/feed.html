<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anonymous Wall - Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header><h1>ðŸ’¬ Anonymous Wall</h1></header>

  <main>
    <!-- Views -->
    <section class="card">
      <div class="tabs">
        <button id="tabFeed" class="active">Public Feed</button>
        <button id="tabMine" class="">My Posts</button>
      </div>

      <div id="feed" class="panel"></div>
      <div id="mine" class="panel hidden"></div>
    </section>
  </main>

  <footer>
    <button id="logoutBtn" class="ghost hidden">Logout</button>
  </footer>

  <script>
    const API_BASE = '';

    const els = {
      tabFeed: document.getElementById('tabFeed'),
      tabMine: document.getElementById('tabMine'),
      feed: document.getElementById('feed'),
      mine: document.getElementById('mine'),
      logoutBtn: document.getElementById('logoutBtn'),
    };

    function token() { return localStorage.getItem('jwt'); }
    function setToken(t) { t ? localStorage.setItem('jwt', t) : localStorage.removeItem('jwt'); }

    function setLoggedInUI(user) {
      if (els.authStatus) {
        els.authStatus.textContent = user ? `Logged in as ${user.username}` : '';
      }
      if (els.logoutBtn) {
        els.logoutBtn.classList.toggle('hidden', !user);
      }
    }

    async function me() {
      const t = token();
      if (!t) return null;
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { headers: { Authorization: `Bearer ${t}` }});
        if (!res.ok) throw 0;
        const data = await res.json();
        return data.user;
      } catch { return null; }
    }

    function renderPost(p, mineView=false) {
      const sentClass = p.sentiment === 'positive' ? 'sent-pos' : p.sentiment === 'negative' ? 'sent-neg' : 'sent-neu';
      const tags = (p.tags || []).map(t => `<span class="badge">${t}</span>`).join(' ');
      const when = new Date(p.createdAt).toLocaleString();
      const who = p.anonymous ? 'Anonymous' : (p.author || 'Unknown');

      let actions = '';
      if (mineView) {
        actions = `
          <div class="actions">
            <button onclick="editPost('${p.id}', '${encodeURIComponent(p.text)}', ${p.anonymous})">Edit</button>
            <button onclick="deletePost('${p.id}')">Delete</button>
          </div>
        `;
      }

      return `
        <div class="post">
          <div>${p.text.replace(/</g,'<')}</div>
          <div class="meta">
            <span class="badge ${'sent-'+p.sentiment[0]+p.sentiment.slice(1,3)} ${sentClass}">${p.sentiment}</span>
            ${tags}
            <span class="badge">${who}</span>
            <span class="badge">${when}</span>
          </div>
          ${actions}
        </div>
      `;
    }

    async function loadFeed() {
      const res = await fetch(`${API_BASE}/api/posts`, {
        headers: token() ? { Authorization: `Bearer ${token()}` } : {}
      });
      const data = await res.json();
      if (!Array.isArray(data)) { els.feed.textContent = 'Failed to load.'; return; }
      els.feed.innerHTML = data.map(p => renderPost(p, false)).join('') || 'No posts yet.';
    }

    async function loadMine() {
      if (!token()) { els.mine.innerHTML = 'Login to see your posts.'; return; }
      const res = await fetch(`${API_BASE}/api/my-posts`, {
        headers: { Authorization: `Bearer ${token()}` }
      });
      const data = await res.json();
      if (!Array.isArray(data)) { els.mine.textContent = 'Failed to load.'; return; }
      // augment for renderer
      const mine = data.map(p => ({ ...p, author: 'You' }));
      els.mine.innerHTML = mine.map(p => renderPost(p, true)).join('') || 'You have no posts.';
    }

    window.editPost = async function(id, encodedText, anonymous) {
      const current = decodeURIComponent(encodedText);
      const text = prompt('Edit your post:', current);
      if (text === null) return;
      const anon = confirm('Post anonymously? OK = Yes, Cancel = No');
      const res = await fetch(`${API_BASE}/api/posts/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token()}` },
        body: JSON.stringify({ text, anonymous: anon })
      });
      const out = await res.json();
      if (!res.ok) { alert(out.error || 'Update failed'); return; }
      loadFeed(); loadMine();
    }

    window.deletePost = async function(id) {
      if (!confirm('Delete this post?')) return;
      const res = await fetch(`${API_BASE}/api/posts/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token()}` }
      });
      const out = await res.json();
      if (!res.ok) { alert(out.error || 'Delete failed'); return; }
      loadFeed(); loadMine();
    }

    if (els.logoutBtn) {
      els.logoutBtn.onclick = () => {
        setToken(null);
        setLoggedInUI(null);
        // Redirect to account.html after logout
        window.location.href = '/account.html';
      };
    }

    // init
    (async () => {
      const user = await me();
      setLoggedInUI(user);
      loadFeed();
    })();
  </script>
</body>
</html>
